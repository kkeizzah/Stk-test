<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Test STK Push • HELB Disbursement</title>
<style>
  :root { --bg:#0f0f0f; --card:#141414; --brand:#ffd400; --muted: #9b9b9b; }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    background: linear-gradient(180deg,#070707 0%, #0f0f0f 100%); color:#fff;
    min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px;
  }
  .card{
    width:100%; max-width:460px; background:var(--card); border-radius:12px; padding:22px;
    box-shadow: 0 10px 30px rgba(0,0,0,.6); border:1px solid rgba(255,255,255,0.03);
  }
  h1{margin:0 0 6px; font-size:20px}
  p.lead{margin:0 0 18px; color:var(--muted); font-size:13px}
  label{display:block; font-size:13px; margin-top:12px; color:#ddd}
  input[type="tel"], input[type="text"]{
    width:100%; padding:12px 14px; margin-top:6px; border-radius:8px; border:1px solid #222;
    background:#0d0d0d; color:#fff; font-size:15px;
  }
  .small{font-size:12px; color:var(--muted); margin-top:8px}
  .controls{display:flex; gap:10px; margin-top:18px}
  button{
    flex:1; padding:12px 14px; border-radius:8px; border:none; background:var(--brand);
    color:#000; font-weight:700; cursor:pointer; font-size:15px;
  }
  .btn-secondary{background:#222; color:#fff; border:1px solid #2a2a2a}
  .note{font-size:13px; color:var(--muted); margin-top:14px}
  .log{margin-top:16px; background:#0b0b0b; border:1px dashed #222; padding:12px; border-radius:8px; font-family:monospace; font-size:13px; color:#dcdcdc; max-height:220px; overflow:auto}
  .status-success{color:#8be78b}
  .status-fail{color:#ff7b7b}
  .flex-row{display:flex; gap:8px; align-items:center; margin-top:12px}
  .toggle{display:inline-flex; align-items:center; gap:8px}
  .small-input{width:120px}
</style>
</head>
<body>
  <div class="card" role="main" aria-labelledby="title">
    <h1 id="title">Test STK Push — HELB Disbursement</h1>
    <p class="lead">This form initiates an STK Push for <strong>KES 25,000</strong> to Till <strong>6434270</strong>. The backend must be at an HTTPS endpoint that runs the Daraja flow.</p>

    <label for="phone">Phone number (format: <em>2547XXXXXXXX</em>)</label>
    <input id="phone" type="tel" inputmode="numeric" placeholder="2547XXXXXXXX" value="254700000000" />

    <div class="flex-row">
      <div class="toggle">
        <input id="useMock" type="checkbox" checked />
        <label for="useMock" style="font-size:13px;color:var(--muted)">Use mock (no backend)</label>
      </div>

      <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <label style="font-size:13px;color:var(--muted);">API URL</label>
        <input id="apiUrl" class="small-input" type="text" value="api/stk_push.php" />
      </div>
    </div>

    <div class="controls">
      <button id="sendBtn">Send STK Push</button>
      <button id="clearBtn" class="btn-secondary" type="button">Clear Log</button>
    </div>

    <p class="note">Note: STK popup text is controlled by Safaricom — you cannot set an arbitrary message inside the secure PIN prompt. This form sends a request to the configured API endpoint with the phone and fixed amount (KES 25,000).</p>

    <div id="log" class="log" aria-live="polite">
      Log output will appear here — mock mode is on by default so you can test immediately.
    </div>
  </div>

<script>
(function(){
  const phoneInput = document.getElementById('phone');
  const sendBtn = document.getElementById('sendBtn');
  const clearBtn = document.getElementById('clearBtn');
  const logEl = document.getElementById('log');
  const useMockCheckbox = document.getElementById('useMock');
  const apiUrlInput = document.getElementById('apiUrl');

  const FIXED_AMOUNT = 25000;
  const SHORTCODE = '6434270';
  const ACCOUNT_REF = 'HELB Disbursement';

  function log(msg, cls){
    const line = document.createElement('div');
    if(cls) line.className = cls;
    line.textContent = '[' + new Date().toLocaleTimeString() + '] ' + msg;
    logEl.prepend(line);
  }

  function validatePhone(phone){
    return /^2547\d{8}$/.test(phone);
  }

  async function doMockFlow(phone){
    log('Mock: initiating STK Push for ' + phone + ' amount KES ' + FIXED_AMOUNT + ' to Till ' + SHORTCODE);
    // simulate server network delay
    await new Promise(r=>setTimeout(r, 900));
    // return fake success response (like Daraja)
    const mockResponse = {
      ok: true,
      message: 'STK Push initiated (mock)',
      checkout_id: 'MOCK_' + Date.now()
    };
    log('Mock Response: ' + JSON.stringify(mockResponse));
    log('User should see M-Pesa prompt on phone (mock).', 'status-success');
    return mockResponse;
  }

  async function callApi(phone, apiUrl){
    // prepare form data
    const form = new FormData();
    form.append('phone', phone);
    form.append('amount', FIXED_AMOUNT);

    log('Sending request to ' + apiUrl + ' ...');
    try {
      const res = await fetch(apiUrl, {
        method: 'POST',
        body: form,
        credentials: 'include' // if cookie/session needed
      });
      const text = await res.text();
      // try parse JSON
      let obj;
      try { obj = JSON.parse(text); }
      catch(e) { obj = null; }
      if(res.ok){
        log('HTTP ' + res.status + ' — response: ' + (obj ? JSON.stringify(obj) : text));
        if(obj && obj.ok){
          log('STK Push queued (checkout_id: '+ (obj.checkout_id || 'n/a') +')', 'status-success');
        } else {
          log('Server returned OK but payload indicates failure: ' + (obj ? JSON.stringify(obj) : text), 'status-fail');
        }
      } else {
        log('HTTP ' + res.status + ' — error: ' + (obj ? JSON.stringify(obj) : text), 'status-fail');
      }
      return obj || { raw: text, status: res.status };
    } catch(err){
      log('Network / fetch error: ' + err.message, 'status-fail');
      throw err;
    }
  }

  sendBtn.addEventListener('click', async function(){
    const phone = phoneInput.value.trim();
    const useMock = useMockCheckbox.checked;
    const apiUrl = apiUrlInput.value.trim();

    if(!validatePhone(phone)){
      alert('Enter phone in format 2547XXXXXXXX');
      return;
    }

    // disable inputs during send
    sendBtn.disabled = true;
    sendBtn.textContent = 'Sending...';
    phoneInput.disabled = true;
    useMockCheckbox.disabled = true;
    apiUrlInput.disabled = true;

    try {
      if(useMock){
        await doMockFlow(phone);
      } else {
        if(!apiUrl){
          alert('Please set the API URL (e.g., https://yourdomain.com/api/stk_push.php)');
          return;
        }
        await callApi(phone, apiUrl);
      }
    } catch(e){
      console.error(e);
    } finally {
      sendBtn.disabled = false;
      sendBtn.textContent = 'Send STK Push';
      phoneInput.disabled = false;
      useMockCheckbox.disabled = false;
      apiUrlInput.disabled = false;
    }
  });

  clearBtn.addEventListener('click', function(){
    logEl.innerHTML = '';
  });

  // initial example log
  log('UI ready. Mock mode is ' + (useMockCheckbox.checked ? 'ON' : 'OFF') + '. Edit API URL and uncheck Mock to call your backend.');
  log('Remember: backend must be HTTPS and implement Daraja STK Push.');
})();
</script>
</body>
</html>
